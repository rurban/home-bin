#!/bin/sh
cd /usr/src/parrot/smoke || exit
lock=/usr/src/parrot/smoke.lock

trap "rm $lock; exit 255" INT TERM
if [ -e $lock ]; then
  echo "Another smoker still running, $lock exists"
  exit
fi

branch=${1:-master}
test -n "$1" && shift
# stash changes if dirty or detached head
if git symbolic-ref -q HEAD >/dev/null
then
  if git status|grep " Changes " 2>/dev/null
  then
    git stash save "smoke `date +%F` `git name-rev --name-only HEAD`"
  fi
fi
fbranch=smoked."`echo $branch|sed -e's,/,_,'`"
git fetch origin
oldrev="`cat ../$fbranch`"
newrev="`git rev-parse origin/$branch`"
if [ x$oldrev = x$newrev ]
then
  echo "no changes for $branch $newrev"
else
  git checkout $branch
  git clean -dxf || git clean -d -x
  git reset --hard
  git pull -q origin $branch </dev/null >/dev/null 2>/dev/null
  git reset --hard origin/$branch
  echo $newrev >$lock
  perl Configure.pl --optimize --cc="ccache g++" --link="ccache g++" --ld="ccache g++" $@ >/dev/null
  make -s
  make -s smolder_test && git rev-parse $branch && echo $newrev >../$fbranch
  rm $lock
fi
