#!/bin/bash
branches="master threads native_pbc native_pbc2 coke/rm_pasm whiteknight/rm_pasm2 relocatable-gh800 nqp-p6"
# plus all rurban and smoke-me

# at last smoke-me branches
cd /usr/src/parrot/smoke

# stash changes if dirty or detached head
if git symbolic-ref -q HEAD >/dev/null
then
  if git status|grep " Changes " 2>/dev/null
  then
      stashname="smoke `date +%F` `git name-rev --name-only HEAD`"
      git stash save $stashname
  fi
fi

for s in `git branch -r | grep '(rurban|smoke-me)/'`
do
    s="`echo $s|sed 's,^origin/,,g'`"
    if [ -n $s -a "${s:0:4}" != "bdw/" ]; then
	branches="$branches $s"
    fi
done
curbranch=`git name-rev --name-only HEAD`

for b in $branches
do
    fbranch="`echo $b|sed -e's,/,_,g'`"
    /bin/sh ~/bin/smoke-parrot $b >>/usr/src/parrot/smoked.$fbranch.log 2>&1
done

git co $curbranch
git reset --hard
test -n $stashname && git stash pop $stashname
